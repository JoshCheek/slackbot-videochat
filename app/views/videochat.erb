<%= erb :structure, layout: false %>

<script src="//media.twiliocdn.com/sdk/js/video/releases/1.0.0-beta2/twilio-video.js"></script>

<script>
"use strict"

var roomName = <%= JSON.dump @room_name %>
var token    = <%= JSON.dump @token %>
var devmode  = <%= @devmode %>

if (!navigator.webkitGetUserMedia && !navigator.mozGetUserMedia)
  alert('WebRTC is not available in your browser.')
else if (devmode)
  mockRoom().then(roomJoined)
else
  new Twilio.Video.Client(token)
    .connect({to: roomName})
    .then(roomJoined, function(e) { alert(e.toString()) })

function mockRoom() {
  var noop = function() {}
  var me   = { identity: 'me', featured: false, media: new Twilio.Video.LocalMedia() }
  return Twilio.Video.getUserMedia().then(function(stream) {
    me.media.addStream(stream)
    return { participants: [], localParticipant: me, on: noop, disconnect: noop }
  })
}


function roomJoined(room) {
  function attach(participant, selector) {
    participant.media.attach(document.querySelector(selector))
    return participant
  }

  var me = attach(room.localParticipant, '.Me .Media')

  // NOTE: room.participants is *NOT* an array >.<
  var you
  room.participants.forEach(function(participant) { you = participant })
  devmode && !you && (you = me)
  you && attach(you, '.You .Media')

  room.on('participantConnected', function(participant) {
    you = attach(participant, '.You .Media')
  })

  room.on('participantDisconnected', function (participant) {
    participant.media.detach()
  })

  room.on('disconnected', function () {
    // ideally do something nice here, realistically this was supposed to be a 4 hr project
  })

  window.addEventListener('beforeunload', function() {
    room.disconnect()
  })
}
</script>
